import{w as z,x as H,j as e,aT as oe,r as _,aF as A,aU as F,ag as $,ah as q,aq as O,aV as T,aW as V,aX as G,aY as Y,aZ as K,a_ as Q,a$ as ae,b0 as le,aB as ie,b1 as ce,aD as ue,b2 as de,F as P,b3 as Se,b4 as B,ae as he,ai as ge,G as X,b5 as fe,b6 as me,aC as W,aS as pe,C as xe,b7 as Ce}from"./index-2ba9b923.js";import{u as Le}from"./searchHookMemory-f6f853e9.js";var N={},Oe=H;Object.defineProperty(N,"__esModule",{value:!0});var Z=N.default=void 0,ve=Oe(z()),ye=e,we=(0,ve.default)((0,ye.jsx)("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"}),"AccountBox");Z=N.default=we;var D={},je=H;Object.defineProperty(D,"__esModule",{value:!0});var J=D.default=void 0,Re=je(z()),Ue=e,be=(0,Re.default)((0,Ue.jsx)("path",{d:"M11 7 9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"}),"Login");J=D.default=be;const Ae={COLUMN_WIDTH:100,COLUMN_UNIT:"%",ROW_HEIGHT:90},Ie={primaryField:"UserId",secondaryField:"CompanyName"};function Ee({usersSSO:s,recherche:r=null,onSelect:t,...o}){const i=Le("usersSSO",s);return e.jsx(e.Fragment,{children:e.jsx(oe,{ItemComponentProps:Ie,ItemMeasureCard:Ae,onSelect:t,IconComponent:Z,labelSearch:"",state:i,...o})})}const ee=_.forwardRef((s,r)=>{const{t}=A(),{error:o,...i}=s,{title:d,severity:n,extended:S}=(()=>o?o instanceof F?{title:o.message,extended:o.extendedMessage,severity:"error"}:{title:t(o.codeResult||""),extended:o.infoResult,severity:"warning"}:{title:null,extended:null,severity:"info"})();return e.jsx($,{ref:r,severity:n,...i,children:e.jsx(q,{children:d})})});function E(s){return{err:s,res:null}}function se(s,r,t,o=!1){const i=()=>{const l=s==null?void 0:s.id;if(l&&O.has(r,l))return l;const m=Object.keys(r);return l&&O.has(r,l)?l:O.first(m)||null},n=(()=>{const l=i();return l&&r[l]||null})();return{isFetching:!1,error:null,errors:[],accessConfigId:(n==null?void 0:n.id)||null,...s,...n&&O.omitBy(n,O.isNil),username:(t==null?void 0:t.username)||((n==null?void 0:n.username)??(s==null?void 0:s.username))||"",password:(o?t==null?void 0:t.password:null)||((n==null?void 0:n.password)??(s==null?void 0:s.password))||"",userSSO:null,accessSSO:null}}function re(s){return s&&O.has(s,"usersSSO")}async function ne(s,r,t){var o,i,d,n,S,l,m,c,u,v,x,R;try{const p=T(null,r);let y={signal:s.signal};const h=await p.getNewToken({variables:{forceDisconnect:t},axiosConfig:y});if(h.err)return E(h.err);if(((o=h.res)==null?void 0:o.codeResult)!=="OK")return E({codeResult:((i=h.res)==null?void 0:i.codeResult)||"CODERESULT",infoResult:((d=h.res)==null?void 0:d.infoResult)||""});if((S=(n=h.res)==null?void 0:n.result)!=null&&S.UsersSSO&&((l=h.res)==null?void 0:l.result.UsersSSO.length)>0)return{err:null,res:{usersSSO:h.res.result.UsersSSO}};if(!((m=h.res)!=null&&m.result)||!((c=h.res)!=null&&c.result.Token))return E(F.MakeExtendedError(":{"));const b=p.parseToken(h.res.result),[C,g,a]=await Promise.all([p.CommunMethods().recupereContext({axiosConfig:y}),p.CommunMethods().recupereDepotUtilisateur({axiosConfig:y}),p.CommunMethods().recuperePersonnelUnique({axiosConfig:y})]),L=C.err||g.err||a.err;if(L)return E(L);const f={...r,companyId:((u=C==null?void 0:C.res)==null?void 0:u.COMPANY_ID)||null};return T(b,f),{res:{accessConfig:f,token:b,etablissementCode:((v=g.res)==null?void 0:v.DEP_CODE)||null,etablissementLib:((x=g.res)==null?void 0:x.DEP_LIBELLE)||"",societe:((R=C==null?void 0:C.res)==null?void 0:R.COMPANY_NAME)||null,personnelUnique:(a==null?void 0:a.res)||null},err:null}}catch(p){return E(F.MakeCatchError(p))}}let M=new AbortController;const Fe=()=>{const{t:s}=A(),r=V(),{onAutoLoginReset:t,onLoginFailure:o,onLoginSuccess:i,onOpenUsersSSO:d,...n}=G(),{listAccess:S,noAccessSet:l}=Y(),m=K(),c=Q(),u=ae(),[v,x]=_.useState({showRetry:!1,showUserSSO:!1,usersSSO:[]}),R=()=>{t(-1)},p=g=>{x({errorLogin:g,showRetry:!0,showUserSSO:!1,usersSSO:[]})},y=(g,a)=>{(async()=>{try{u.showModalWaitLock();const f=se(n.accessConfig,S,r,!0),w=S[f.accessConfigId],{err:I,res:j}=await ne(M,{...w,username:f.username||"",password:f.password||"",companyId:null,userSSO:g||"",access:a||w.access},!0);u.closeModalWaitLock(),I?p(I):re(j)?x(U=>({...U,showUserSSO:!0,usersSSO:j.usersSSO})):(i(j),m(),c("/?autoSelect=true"))}catch(f){p(F.MakeCatchError(f))}finally{u.closeModalWaitLock()}})()},h=g=>{y(g.UserId,g.AccessId)},b=()=>{x({errorLogin:null,showRetry:!1,showUserSSO:!1,usersSSO:[]}),y(null,null)},C=()=>{t(-1)};return _.useEffect(()=>{l?t(-1):y(null,null)},[l]),{localState:v,handleCloseModal:R,handleLoginUSERSSO:h,onRetry:b,onCancel:C,t:s}},Me=()=>{var g;const s=V();A();const r=Q(),{onLoginFailure:t,onLoginSuccess:o,onOpenUsersSSO:i,...d}=G(),{listAccess:n,noAccessSet:S}=Y(),{onOpenConfigureAccess:l}=le(),m=K(),[c,u]=_.useState(()=>({...se(d.accessConfig,n,s,!1),showUserSSO:!1,usersSSO:[],errorLogin:null})),v=a=>u(L=>({...L,...a})),x=a=>{const L=a.target.name,f=a.target.value;u(w=>({...w,[L]:f,codeResult:null,errorLogin:null}))},R=async(a,L,f,w)=>{if(c.isFetching){try{M.abort()}catch{}return}const I=n[c.accessConfigId],j=[];if(c.username||j.push("username"),c.accessConfigId||j.push("access"),j.length!==0)u(U=>({...U,errors:j}));else{M=new AbortController,v({showUserSSO:!1,isFetching:!0,errors:[],errorLogin:null,...L&&{userSSO:f,accessSSO:w}});const{err:U,res:k}=await ne(M,{...I,username:c.username||"",password:c.password||"",userSSO:f||"",access:w||I.access,companyId:null},a);U?v({isFetching:!1,errorLogin:U}):re(k)?v({showUserSSO:!0,usersSSO:k.usersSSO,isFetching:!1,errorLogin:null}):(m(),o(k),r("/?autoSelect=true"))}},p=a=>R(a,!1,c.userSSO||null,c.accessSSO||null),y=()=>{u(a=>({...a,showUserSSO:!1,usersSSO:[]}))},h=a=>R(!1,!0,a.UserId,a.AccessId),b=a=>{u(L=>({...L,accessConfigId:a.id,...O.omitBy(a,O.isNil)}))},C=()=>{u(a=>({...a,accessConfigId:""}))};return{localState:c,alreadyConnected:c.errorLogin instanceof F?!1:((g=c.errorLogin)==null?void 0:g.codeResult)==="ERR_ALREADY_CONNECTED",noAccessSet:S,listAccess:n,handleLogin:p,handleLoginUSERSSO:h,handleCloseModal:y,handleUpdateForm:x,handleSetAccess:b,handleClearAccess:C,onOpenConfigureAccess:l}};function _e({helperMsg:s,error:r,disabled:t,accessConfigId:o,onSetAccess:i,onClearAccess:d,listAccess:n}){const{t:S}=A(),l=O.values(n);return e.jsx(ie,{label:S("configuration"),disabled:t,addEmpty:!1,helperText:S("configureAcces"),onChange:m=>{i(m)},onClear:d,values:l,className:"",value:o&&n[o]||null,SelectProps:{key:"id",label:"label"},labelEmpty:""})}const ke={overflow:"auto","& .form":{margin:1},"& .footer":{width:"100%","& .hidden":{visibility:"hidden",opacity:0}},"& .submit":{marginTop:1.5},"& .error":{height:1,color:"red"}},Ne=({usersSSO:s,onSelect:r})=>e.jsx(Ce,{children:e.jsx(Ee,{usersSSO:s,onSelect:r})}),te=({children:s,usersSSO:r,handleLoginUSERSSO:t,showUserSSO:o,handleCloseModal:i})=>{const{t:d}=A();return e.jsxs(W,{sx:ke,container:!0,flexGrow:1,alignItems:"center",justifyContent:"center",children:[e.jsx(pe,{withAppBar:!0,isOpen:o,className:"",onCloseDialog:i,children:e.jsx(Ne,{usersSSO:r,onSelect:t})}),e.jsxs(W,{item:!0,sx:{boxShadow:1,p:1},xs:12,sm:8,md:7,lg:5,children:[e.jsxs(X,{display:"flex",alignItems:"center",children:[e.jsx("img",{src:"./logo.png",alt:"",style:{width:26,height:26}}),e.jsx(xe,{sx:{m:1,lineHeight:2},variant:"h4",color:"text.secondary",children:d("welcome")})]}),s]})]})},De=()=>{const{t:s}=A(),{localState:r,noAccessSet:t,listAccess:o,handleLogin:i,handleLoginUSERSSO:d,handleCloseModal:n,handleUpdateForm:S,handleSetAccess:l,handleClearAccess:m,onOpenConfigureAccess:c,alreadyConnected:u}=Me(),v=x=>{x.preventDefault(),i(u)};return e.jsx(te,{usersSSO:r.usersSSO,handleLoginUSERSSO:d,showUserSSO:r.showUserSSO,handleCloseModal:n,children:t?e.jsxs($,{severity:"info",children:[e.jsx(q,{children:s("firstLaunch")}),e.jsx(P,{variant:"contained",color:"primary",onClick:x=>c(!0),children:s("configureAcces")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:v,className:"form",autoComplete:"off",name:"login",children:[e.jsx(_e,{disabled:r.isFetching,error:O.includes(r.errors,"access"),listAccess:o,accessConfigId:r.accessConfigId,onSetAccess:l,onClearAccess:m}),e.jsx(ue,{error:O.includes(r.errors,"username"),variant:"outlined",margin:"normal",fullWidth:!0,label:s("username"),value:r.username,onChange:S,name:"username",disabled:r.isFetching}),e.jsx(de,{disabled:r.isFetching,variant:"outlined",margin:"normal",fullWidth:!0,label:s("password"),value:r.password||"",onChange:S,name:"password"}),e.jsx(P,{type:"submit",color:r.isFetching?"error":u?"warning":"primary",fullWidth:!0,size:"large",variant:"contained",startIcon:r.isFetching?e.jsx(Se,{fontSize:"large"}):e.jsx(J,{fontSize:"large"}),className:B("submit"),children:s(r.isFetching?"cancel":u?"forceLogin":"login")})]}),e.jsxs("div",{className:"footer",children:[e.jsx(he,{classes:{root:B({hidden:!r.isFetching})}}),e.jsx(ge,{in:!!r.errorLogin,children:e.jsx(ee,{error:r.errorLogin})})]})]})})},Te=()=>{const{localState:s,handleCloseModal:r,handleLoginUSERSSO:t,onRetry:o,onCancel:i,t:d}=Fe();return e.jsx(e.Fragment,{children:s.showRetry&&e.jsxs(te,{usersSSO:s.usersSSO,handleLoginUSERSSO:t,showUserSSO:s.showUserSSO,handleCloseModal:r,children:[e.jsx(ee,{error:s.errorLogin||null}),e.jsxs(X,{display:"grid",gridTemplateColumns:"repeat( auto-fit, minmax(200px, 1fr) )",gap:1,m:2,children:[e.jsx(fe,{onClick:o}),e.jsx(me,{onClick:i,variant:"contained",size:"large"})]})]})})},We=()=>ce()?e.jsx(Te,{}):e.jsx(De,{});export{We as default};
