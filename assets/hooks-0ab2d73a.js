import{gj as dn,e$ as Ke,gk as yn,gl as K,gm as Ie,gn as pe,go as Bn,gp as Fn,gq as bn,gr as wn,gs as kn,gt as xn,gu as vn,gv as Yn,gw as Hn,gx as Qn,gy as qn,gz as Kn,gA as jn,au as je,r as k,fq as Wn,aq as c,c5 as ie,as as y,az as Oe,aF as Gn,a$ as We,eA as j,c6 as Ne,j as U,C as _e,s as Ge,ae as zn,ey as Be,dG as Se,b4 as Pe,cB as Zn,cC as $n,G as J,cv as Xn,cD as Fe,cE as Jn,bE as be,gb as er,ax as ee,aw as nr,ej as rr,gB as lr,gC as ir,gD as or,el as B,ar as sr,fb as tr,fe,ff as ur,gE as cr,gF as _r}from"./index-2ba9b923.js";import{u as ze,h as Er,i as Tr,j as Nr,k as Cr}from"./actions-d163bdb2.js";import{a as Ir}from"./lneContainerFidege-213a2d35.js";function Ze(e){return e[e.length-1]}function Or(e){return dn(Ze(e))?e.pop():void 0}function Ar(e,r){return typeof Ze(e)=="number"?e.pop():r}function $e(e,r){return r===void 0&&(r=0),Ke(function(l,n){l.subscribe(yn(n,function(o){return K(n,e,function(){return n.next(o)},r)},function(){return K(n,e,function(){return n.complete()},r)},function(o){return K(n,e,function(){return n.error(o)},r)}))})}function Xe(e,r){return r===void 0&&(r=0),Ke(function(l,n){n.add(e.schedule(function(){return l.subscribe(n)},r))})}function ar(e,r){return Ie(e).pipe(Xe(r),$e(r))}function Dr(e,r){return Ie(e).pipe(Xe(r),$e(r))}function Rr(e,r){return new pe(function(l){var n=0;return r.schedule(function(){n===e.length?l.complete():(l.next(e[n++]),l.closed||this.schedule())})})}function Sr(e,r){return new pe(function(l){var n;return K(l,r,function(){n=e[Bn](),K(l,r,function(){var o,s,_;try{o=n.next(),s=o.value,_=o.done}catch(E){l.error(E);return}_?l.complete():l.next(s)},0,!0)}),function(){return Fn(n==null?void 0:n.return)&&n.return()}})}function Je(e,r){if(!e)throw new Error("Iterable cannot be null");return new pe(function(l){K(l,r,function(){var n=e[Symbol.asyncIterator]();K(l,r,function(){n.next().then(function(o){o.done?l.complete():l.next(o.value)})},0,!0)})})}function Pr(e,r){return Je(bn(e),r)}function fr(e,r){if(e!=null){if(wn(e))return ar(e,r);if(kn(e))return Rr(e,r);if(xn(e))return Dr(e,r);if(vn(e))return Je(e,r);if(Yn(e))return Sr(e,r);if(Hn(e))return Pr(e,r)}throw Qn(e)}function Vr(e,r){return r?fr(e,r):Ie(e)}function mr(e){return e===void 0&&(e=1/0),qn(Kn,e)}function gr(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var l=Or(e),n=Ar(e,1/0),o=e;return o.length?o.length===1?Ie(o[0]):mr(n)(Vr(o,l)):jn}const Ve=()=>{const e=je();return k.useCallback(r=>e.showError({i8nmessage:r,title:"error",dialogProps:{maxWidth:"md",fullWidth:!0}}),[])};function pr(e){return c.stringConcat(e.VEN_COM_PREPA,e.VEN_COM_PREPA2,e.LIVC_COM_PREPA)}function ul(e){const r=pr(e);return{itemKey:e.VEN_NUMSEQ,addFooter:!!r,commentaire:r}}const we={domain:[0,100],range:["orange","green"]},ke=Wn().domain(we.domain).range(we.range);function en(e){var r;return!!(e&&e.VEN_UNIT_CDE==="C"&&c.includes(["BOX","BINS"],(r=e==null?void 0:e.Article)==null?void 0:r.ART_RUB5))}function Le(e,r=!0){var n,o;const l=[];if(e){if(en(e)&&l.push("BOX "),e.VEN_UNIT_CDE=="P"&&((n=e.Article)==null?void 0:n.ART_PIECE_COL)!=0&&(((o=e.Article)==null?void 0:o.SPECIF_NUMERIC_4)||0)>1){l.push("Soit ");let s=c.floor(e.VEN_QTE_CDE/e.Article.ART_PIECE_COL,0);s&&l.push(s+" Colis ");let _=c.round((e.VEN_QTE_CDE-s*e.Article.ART_PIECE_COL)/e.Article.SPECIF_NUMERIC_4,3);_&&s&&l.push("et "),_&&l.push(_+" lot(s) ")}r&&e.VEN_COMMENT&&l.push(e.VEN_COMMENT)}return c.join(l,"")}function cl(e){const r=e.VEN_LOT_SEQ,l=Le(e);return e.VEN_MATURITE?{itemKey:r,addFooter:!0,commentaire:{primary:l,secondary:e.VEN_MATURITE}}:{itemKey:r,addFooter:!!l,commentaire:l}}function _l(e){return{VEN_CDE:e.VEN_CDE,VEN_NUMSEQ:e.VEN_NUMSEQ}}const El=(e,r,l={})=>ie(["PreparationFidegeByNumRemote",e.getQueryKey(),r],()=>y().PrepaFidegeMethods().ListeCommandeClientFidege({variables:{recherche:{rbp:1,qbRules:Oe("VEN_NUMSEQ",r,"=")},context:null}}).then(({err:n,res:o})=>({err:n,res:c.head(o==null?void 0:o.result)||null})),l),Tl=(e,r,l={})=>ie(["PreparationFidegeByVenCdeRemote",e.getQueryKey(),r],()=>y().PrepaFidegeMethods().ListeCommandeClientFidege({variables:{recherche:{rbp:1,qbRules:Oe("VEN_CDE",r,"=")},context:e.current}}),l);function Nl(e){const{t:r}=Gn(),l=Ve(),n=We(),{clearCache:o}=ze();return j({mutationFn:s=>(n.showModalWaitLock(),y().PrepaFidegeMethods().TerminePreparationDetailFidege({variables:{mutation:s,context:e.current}})),onSettled:s=>{if(n.closeModalWaitLock(),s){const{res:_}=s;(_==null?void 0:_.codeResult)==="OK"||l(r((_==null?void 0:_.codeResult)||"errorMessage"))}o()}})}const Cl=(e,r,l,n={})=>ie([Er,e.getQueryKey(),l],()=>y().PrepaFidegeMethods().PreparationParArticleFidege({variables:{recherche:{rbp:1,qbRules:Oe("detail.VEN_ART_CODE",l,"=")},filtresOptionnels:r,context:(e==null?void 0:e.current)||null}}).then(({err:o,res:s})=>({err:o,res:c.head(s==null?void 0:s.result)||null})),n),Lr=(e,r,l)=>Promise.all([Ne(y().PrepaMethods().ListeCommandeClient({variables:{recherche:{rbp:1,qbRules:Oe("VEN_NUMSEQ",r,"=")},context:null}}).then(({err:n,res:o})=>({err:n,res:c.head(o==null?void 0:o.result)||null}))),Ne(y().PrepaFidegeMethods().DetailPreparationFidege({variables:{context:e,demande:l}}))]).then(([n,o])=>{var s;return{entete:n.res,detail:(s=o.res)==null?void 0:s.result}}),Mr=(e,r,l,n={})=>ie([Tr,e.getQueryKey(),r,l],()=>Lr(e.current,r,l),n),Il=(e,r,l={})=>ie([Nr,e.getQueryKey(),r],({signal:n})=>Ne(y().PrepaFidegeMethods().RechercheCommandePrioritaire({axiosConfig:{signal:n},variables:{demande:{},context:e.current}})),l);function Ur({variant:e="h6",PICK_CODE:r,...l}){return r?U.jsx(_e,{className:"picking",variant:e,color:"secondary",sx:n=>({bgcolor:n.palette.background.paper,textAlign:"center",p:.4,border:1}),...l,children:r}):null}const hr=Ge(zn)(({theme:e,value:r})=>({"&":{backgroundColor:"rgba(0,0,0,0.3)"},"& > .MuiLinearProgress-bar":{color:r>100?"red":ke(r),backgroundColor:r>100?"red":ke(r)}})),Ol={COLUMN_WIDTH:100,COLUMN_UNIT:"%",ROW_HEIGHT:140,md:{COLUMN_WIDTH:100,COLUMN_UNIT:"%",ROW_HEIGHT:80}},xe=(e,r)=>{const l=c.max(c.map(e,n=>c.size(n)))||0;return l>8?"h6":l>6?"h5":"h4"},dr=(e,r=!1)=>r&&((e==null?void 0:e.VEN_QTE_CDE)??0)>((e==null?void 0:e.VEN_QTE_LIV)??0)?e?(e.STO_TOT||0)<=0?"orange":"jaune":"":e?e.NB_TRANS_NONVAL?(e.STO_TOT||0)<=0?"orange":"jaune":"green":"",yr=Ge(Ir)({position:"relative",display:"grid",padding:"0 8px",width:"100%",flexBasis:"100%",gridTemplateColumns:"6ch minmax(0, 1fr) 230px 160px",gridTemplateAreas:'"picking article qtecde qtefac"',"& .hl.input-uvc":{borderLeftWidth:2,position:"relative",height:"calc(100% - 8px)","& .MuiSvgIcon-root":{fontSize:"30px"}}}),Al=({className:e,item:r,ItemComponentProps:l,onSelect:n,style:o,...s})=>{var A,p,Y,w;const _=((A=r.Article)==null?void 0:A.Picking)||null,E=r.Article||{ART_RUB1:null,ART_STAT_IMAGE:null,ART_CODE:null,ART_LIB1:null,ART_PAYS:null},T=r.VEN_UNIT_CDE&&(l!=null&&l.format)?Be(r.VEN_UNIT_CDE,l==null?void 0:l.format):null,I=r.VEN_UNIT_VE&&(l!=null&&l.format)?Be(r.VEN_UNIT_VE,l==null?void 0:l.format):null,N=r.VEN_QTE_CDE?c.round(+r.VEN_QTE_LIV/+r.VEN_QTE_CDE,2)*100:0,S=Le(r),P=Se(r.VEN_QTE_LIV,(T==null?void 0:T.precision)??4),M=Se(r.VEN_QTE_CDE,(T==null?void 0:T.precision)??4),h=Se(r.VEN_QTE_FAC,(I==null?void 0:I.precision)??4),g=r.VEN_UNIT_VE!=((p=r.Article)==null?void 0:p.ART_UNIT_VEN),O=xe([M,P]),a=xe([h]);return U.jsxs(yr,{style:o,noMargin:!0,_properties:r._properties,onDelete:()=>l==null?void 0:l.onOpenFenetreManquantDetail(r.VEN_LOT_SEQ,r.VEN_NUMSEQ),className:Pe(e,"line-preparation-detail-fidege",dr(r)),onClick:F=>n(r),disabledBtDel:!(r.VEN_QTE_LIV<r.VEN_QTE_CDE||r.NB_TRANS_NONVAL>0),children:[Zn(r)&&U.jsx($n,{lockByName:r.VERROU_USER}),U.jsx(Ur,{gridArea:"picking",variant:"h6",PICK_CODE:(_==null?void 0:_.PICK_CODE)||""}),U.jsxs(J,{display:"flex",alignItems:"center",className:"article",gridArea:"article",children:[U.jsx(Xn,{codeStat:E.ART_STAT_IMAGE,fontSize:"inherit"}),U.jsxs(J,{display:"flex",flexDirection:"column",sx:{overflow:"hidden"},children:[U.jsxs(J,{display:"flex",alignItems:"center",columnGap:.4,children:[U.jsx(Fe,{field:"ART_CODE",typoProps:{noWrap:!0,variant:"subtitle2",color:"textPrimary"},content:E.ART_CODE,matchSearch:(Y=r._properties)==null?void 0:Y.matchSearch}),!!E.ART_PAYS&&E.ART_PAYS!=="0"&&U.jsx(Jn,{svg:!0,countryCode:E.ART_PAYS})]}),U.jsx(Fe,{field:"ART_LIB1",typoProps:{noWrap:!!S,overflow:"hidden",variant:"h5"},content:E.ART_LIB1,matchSearch:(w=r._properties)==null?void 0:w.matchSearch})]})]}),U.jsxs(J,{display:"flex",className:Pe("hl","input-uvc","shadow-2","m1","UC","LIV"),gridArea:"qtecde",flexDirection:"column",children:[U.jsx(_e,{sx:{padding:0,color:F=>F.palette.grey[600],textAlign:"center"},variant:"caption",children:"Préparé / Commandé"}),U.jsxs(J,{display:"flex",alignItems:"center",flexDirection:"row",flex:1,children:[U.jsx(_e,{component:"span",sx:{flexGrow:1,color:"inherit",textAlign:"center"},variant:O,children:P}),"/",U.jsx(_e,{component:"span",sx:{flexGrow:1,color:"inherit",textAlign:"center"},variant:O,children:M}),U.jsx(be,{fontSize:"medium",className:"icon icon-uvc with-border",uvc:en(r)?"BOX":r.VEN_UNIT_CDE||""})]}),U.jsx(hr,{sx:{position:"absolute",bottom:1,left:2,right:2},value:N,variant:"determinate"})]}),U.jsx(er,{variant:a,gridArea:"qtefac",className:Pe("hl","input-uvc","shadow-2","UV",{UVMOD:g}),sxLabel:{justifyContent:"center"},textAlign:"right",sx:{position:"relative"},label:"Facturé",text:h,iconPosition:"bodyRight",Icon:U.jsx(be,{className:"icon icon-uvc with-border",fontSize:"medium",uvc:r.VEN_UNIT_VE||""})})]})};let Br=[{type:"NP",config:{initQuantity:!1,calculMode:{C:["P"],N:[]}}},{type:"NC",config:{initQuantity:!1,calculMode:{C:["P"],P:[],N:[]}}}];function Fr(e,r,l){const n=E=>c.includes(["C","P"],E)?E:"N",o=()=>n(e),s=()=>n(r),_=(o()||"")+(s()||"");return c.find(Br,E=>E.type===_)||null}function br(e){return e?!!(e.config&&c.has(e.config,"initQuantity")&&e.config.initQuantity):!0}const wr=e=>e==="NB_PIECES"?"P":e==="NB_COLIS"?"C":"N",kr=e=>e==="P"?"NB_PIECES":e==="C"?"NB_COLIS":"POIDS_NET";function nn(e){return!!e&&!!e.config&&!!e.config.calculMode}function xr(e,r,l){if(nn(e.UVMODIFMODE)){const n=wr(r),o=kr(l);if(c.has(e.UVMODIFMODE.config.calculMode,n)){const s=e.UVMODIFMODE.config.calculMode;return c.includes(s[n],l)||!e[o]&&c.includes(s[n],l+"?")}}return!0}function W(e,r){return!e||!r||e.precision===null?r:c.round(r,e.precision)}function oe(e,r){switch(e){case"C":return"T";case"P":return r.ART_PIE_VEN==="U"?"M":"T";default:return r.ART_PDS_VEN==="U"?"M":"T"}}function le(e,r,l){switch(e){case"C":return 1;case"P":return r||0;default:return l||0}}function re(e,r){var N,S,P,M,h;let l={lotOpen:"",lotOpenIndice:e.newTransaction.indice,erreurCode:null};const n=g=>{var O,a;return c.includes([(O=e.Detail)==null?void 0:O.VEN_UNIT_CDE,(a=e.Detail)==null?void 0:a.VEN_UNIT_VE],g)},o=n("C"),s=n("P"),_=c.includes(["P","C"],(N=e.Detail)==null?void 0:N.VEN_UNIT_CDE)===!1||c.includes(["P","C"],(S=e.Detail)==null?void 0:S.VEN_UNIT_VE)===!1;if(o&&G(e==null?void 0:e.newTransaction.NB_COLIS))return l.lotOpen="ERROR",l.erreurCode="ERR_COLIS_NR",{errorValidation:l,preparationComplete:!1};if(s&&G(e==null?void 0:e.newTransaction.NB_PIECES))return l.lotOpen="ERROR",l.erreurCode="ERR_PIECES_NR",{errorValidation:l,preparationComplete:!1};if(_&&G(e==null?void 0:e.newTransaction.PDS_NET))return l.lotOpen="ERROR",l.erreurCode="ERR_POIDS_NR",{errorValidation:l,preparationComplete:!1};if(r&&!(e!=null&&e.newTransaction.TRA_LOT))return l.lotOpen="CONFIRM_LOT_NOTSET",{errorValidation:l,preparationComplete:!1};const E=((P=e.Detail)==null?void 0:P.VEN_QTE_CDE)||0,T=Ce(((M=e.Detail)==null?void 0:M.VEN_UNIT_CDE)||null,e.Transactions),I=Ce(((h=e.Detail)==null?void 0:h.VEN_UNIT_CDE)||null,[e.newTransaction]);return T+I>E?(l.lotOpen="CONFIRM_DEPASSEMENT",l.lotOpenIndice=e==null?void 0:e.newTransaction.indice,{errorValidation:l,preparationComplete:!0}):{errorValidation:null,preparationComplete:T+I>=E,restant:T+I}}function Ee(e){return!!(e.autoCommit&&!e.lotOpen)}function me(e,r){e.lotOpen=r.lotOpen,e.lotOpenIndice=r.lotOpenIndice,e.erreurCode=r.erreurCode}function vr(e){var r;return((r=re(e,!1).errorValidation)==null?void 0:r.lotOpen)!=="ERROR"}function Me(e,r,l){return r===l.ART_UNIT_VEN?null:Fr(e||"",r||"",oe(r||"",l))}function Yr(e,r){var l;return r?(r.ART_DESTOCK_ART||r.ART_CODE)!==e.VEN_ART_CODE&&r.ART_STAT1!==((l=e.Article)==null?void 0:l.ART_STAT1)?{key:"ERR_SCAN_PRODUCT_NOT_MATCH",options:{label:r.ART_LIB1||""}}:null:{key:"ERR_SCAN_INVALID",options:{batchNumber:"verifArticleCommande"}}}function Ce(e,r){const l=c.map(r,n=>(e||n.VEN_UNIT_CDE)==="C"?n.NB_COLIS||0:(e||n.VEN_UNIT_CDE)==="P"?n.NB_PIECES||0:n.PDS_NET||0);return c.sumByNumber(l)||0}function Hr(e,r){const l=e.TYPE_SAISIE==="T"&&!!e.TRA_LOT&&!!e.NB_COLIS&&!!e.NB_PIECES&&!!e.PDS_NET,n=e.VEN_UNIT_CDE!="N"&&(e.VEN_UNIT_CDE!="P"||e.VEN_UNIT_VE!="N"||e.ART_UNIT_VEN!="P")&&(e.VEN_UNIT_CDE!="C"||e.VEN_UNIT_VE!="N"||e.ART_UNIT_VEN!="P"),o=(e.TYPE_SAISIE==="M"||e.VEN_UNIT_VE==="C")&&!!e.TRA_LOT&&e.VEN_UNIT_VE===e.ART_UNIT_VEN&&n;return r==="TRAITE_EAN"?o||l:o}function Qr(e,r,l){var g,O,a;let n=null,o=null,s=null;const _=e.VEN_UNIT_CDE,E=e.VEN_UNIT_VE,T=r.ACH_PDS_NET&&r.ACH_COLIS?c.round(r.ACH_PDS_NET/r.ACH_COLIS,3):null,I=r.ACH_QUANTITE&&r.ACH_COLIS?c.round(r.ACH_QUANTITE/r.ACH_COLIS,0):null,N=r.Article?oe(E||"",r.Article):null,S=r.Article?Me(_,E,r.Article):null;let P=br(S)?1:0;const M=r.Article;if(M){let A=l&&l.TypeEan==="C"?"C":_;switch(l&&c.includes(["C","P"],A)===!1&&l.PoidsEan&&l.PoidsEan>0&&(P=l.PoidsEan),A==="P"&&M.SPECIF_NUMERIC_4&&(P=M.SPECIF_NUMERIC_4),A){case"C":{n=P,o=c.round(n*(I??0),0),s=c.round(n*(T??0),4),N==="T"&&(E==="P"?o=null:c.includes(["P","C"],E)===!1&&(s=null)),N==="T"&&((g=r.Article)==null?void 0:g.ART_UNIT_VEN)==="P"&&E==="N"&&(n=null,o=null,s=null);break}case"P":{o=P;const p=I?c.sumByNumber([P/I]):P;s=c.round(p*(T??0),4),n=c.round(p,2),N==="T"&&c.includes(["P","C"],E)===!1&&(s=null),((O=r.Article)==null?void 0:O.ART_UNIT_VEN)==="P"&&E==="N"&&(n=null,o=null,s=null);break}default:{s=P;const p=T?c.sumByNumber([P/T]):P;o=c.round(p*(I??0),0),n=c.round(p,2),N==="M"&&((a=r.Article)==null?void 0:a.ART_UNIT_VEN)!=E||(n=null,s=null,o=null)}}l&&l.PoidsEan&&l.PoidsEan>0&&(s=l.PoidsEan)}return{num_colis:n,num_poids:s,num_pieces:o}}function G(e){return e===null?!0:!e}function ve(e,r,l,n,o,s){var h,g;let _=!1;function E(){return nn(n.UVMODIFMODE)}function T(O){return xr(n,o,O)}function I(O){T("C")&&(n.NB_COLIS=W(l.formatColis,c.isNil(O)?null:c.sumByNumber([O])))}function N(O){T("C")&&(n.NB_COLIS=c.isNil(O)?null:c.sumByNumber([O]),_=!0)}function S(O){T("P")&&(n.NB_PIECES=W(l.formatPieces,c.isNil(O)?null:c.sumByNumber([O])))}function P(O){T("N")&&(n.PDS_NET=W(l.formatPoids,c.isNil(O)?null:c.sumByNumber([O])))}function M(){return!(c.isEmpty(r)===!1&&(o==="NB_PIECES"&&c.includes(r,"P")||o==="NB_COLIS"&&c.includes(r,"C")||o==="PDS_NET"&&c.includes(r,"N")))}if(c.includes(["NB_PIECES","NB_COLIS","PDS_NET"],o)){if(n[o]=typeof s=="string"?parseFloat(s):s,o==="NB_PIECES"&&M()&&(E()?((n.PIECE_MOY_LOT||0)!=0&&I(n.NB_PIECES/(n.PIECE_MOY_LOT||0)),(n.PDS_MOY_LOT||0)!=0&&P(n.NB_COLIS*(n.PDS_MOY_LOT||0))):(n.traSeq?n.TYPE_SAISIE==="M"&&!!n.PIECE_MOY_LOT:n.TYPE_SAISIE==="M")?n.PIECE_MOY_LOT&&(n.VEN_UNIT_VE==="P"&&n.NB_COLIS!=0&&n.VEN_UNIT_VE!=n.ART_UNIT_VEN&&n.VEN_UNIT_CDE!=n.VEN_UNIT_VE||N(n.NB_PIECES/(n.PIECE_MOY_LOT||0)),n.VEN_UNIT_CDE==="P"&&n.VEN_UNIT_VE!=n.ART_UNIT_VEN&&(n.PIECE_MOY_LOT||0)!=0?P(n.NB_COLIS*(n.PDS_MOY_LOT||0)):n.VEN_UNIT_VE==="N"&&n.VEN_UNIT_CDE==="P"&&n.ART_UNIT_VEN==="P"||n.VEN_UNIT_VE==="P"&&n.VEN_UNIT_CDE==="N"||n.VEN_UNIT_VE==="P"&&n.PDS_NET!=0&&n.VEN_UNIT_VE!=n.ART_UNIT_VEN&&n.VEN_UNIT_CDE!=n.VEN_UNIT_VE||P((n.NB_COLIS??0)*(n.PDS_MOY_LOT||0))):n.VEN_UNIT_VE!="C"&&n.VEN_UNIT_VE!="P"&&(n.PIECE_MOY_LOT||0)!=0&&I(n.NB_PIECES/(n.PIECE_MOY_LOT||0))),o==="NB_COLIS"&&M()&&(E()?(S(n.NB_COLIS*(n.PIECE_MOY_LOT??0)),P(n.NB_COLIS*(n.PDS_MOY_LOT??0))):n.VEN_UNIT_VE==="C"&&n.VEN_UNIT_CDE==="N"?S(n.PIECE_MOY_LOT===null?null:n.NB_COLIS*n.PIECE_MOY_LOT):n.TYPE_SAISIE==="M"||n.VEN_UNIT_VE==="C"?n.VEN_UNIT_VE!==n.ART_UNIT_VEN&&n.VEN_UNIT_CDE==="C"&&n.TYPE_SAISIE==="M"?(S(n.NB_COLIS*(n.PIECE_MOY_LOT??0)),P(n.NB_COLIS*(n.PDS_MOY_LOT??0))):(n.VEN_UNIT_VE==="C"&&n.PDS_NET&&n.VEN_UNIT_VE!==n.ART_UNIT_VEN&&n.TYPE_SAISIE==="M"&&n.VEN_UNIT_VE!==n.VEN_UNIT_CDE||P(n.NB_COLIS*(n.PDS_MOY_LOT??0)),n.VEN_UNIT_VE==="C"&&n.VEN_UNIT_VE!=n.ART_UNIT_VEN&&n.TYPE_SAISIE==="M"&&n.VEN_UNIT_VE!==n.VEN_UNIT_CDE||S(n.PIECE_MOY_LOT===null?0:n.NB_COLIS*n.PIECE_MOY_LOT)):n.VEN_UNIT_VE!=="C"&&n.VEN_UNIT_VE!=="P"&&S(n.NB_COLIS*(n.PIECE_MOY_LOT||0))),o==="PDS_NET"&&M())if(E())(n.PDS_MOY_LOT||0)!=0&&(N(n.PDS_NET/(n.PDS_MOY_LOT||0)),S((n.NB_COLIS??0)*(n.PIECE_MOY_LOT||0)));else{const O=n.NB_COLIS,a=n.NB_PIECES,A=n.PDS_MOY_LOT||0,p=n.PIECE_MOY_LOT||0;n.VEN_UNIT_CDE=="N"&&n.VEN_UNIT_VE!==n.ART_UNIT_VEN&&A!==0&&n.TYPE_SAISIE=="M"||n.VEN_UNIT_VE=="N"&&n.VEN_UNIT_CDE=="N"&&A!==0?(N(n.PDS_NET/A),S((n.NB_COLIS??0)*p)):n.VEN_UNIT_VE=="C"&&n.VEN_UNIT_CDE=="N"?S((n.NB_COLIS??0)*p):n.VEN_UNIT_VE=="P"&&n.VEN_UNIT_CDE=="N"&&A!==0||n.VEN_UNIT_VE=="N"&&n.VEN_UNIT_CDE=="P"&&n.ART_UNIT_VEN=="P"&&A!==0?N((n.NB_PIECES??0)/p):n.VEN_UNIT_VE=="N"&&n.VEN_UNIT_CDE=="C"&&n.ART_UNIT_VEN=="P"&&A!==0?S((n.NB_COLIS??0)*p):A!==0&&n.TYPE_SAISIE=="M"&&(N((n.PDS_NET??0)/A),S((n.NB_COLIS??0)*p)),n.VEN_UNIT_VE=="N"&&n.VEN_UNIT_VE!==n.ART_UNIT_VEN&&n.TYPE_SAISIE=="M"&&n.VEN_UNIT_CDE!==n.VEN_UNIT_VE&&(O!==0&&I(O),a!==0&&S(a))}if(_&&I(n.NB_COLIS),n.traSeq){let O=null;const a=()=>{e.lotOpen="ERROR",e.erreurCode=O,e.lotOpenIndice=n.indice,Ue(n)},A=n.VEN_UNIT_VE==="C",p=n.VEN_UNIT_VE==="P",Y=(A||p)===!1;if(A&&G(n.NB_COLIS)){O="ERR_COLIS_NR",a();return}if(p&&G(n.NB_PIECES)){O="ERR_PIECES_NR",a();return}if(Y&&G(n.PDS_NET)){O="ERR_POIDS_NR",a();return}const w=((h=e.Detail)==null?void 0:h.VEN_QTE_CDE)||0,F=Ce(((g=e.Detail)==null?void 0:g.VEN_UNIT_CDE)||null,e.Transactions);if(e.autoCommitPreparationComplete=!1,F>w){e.lotOpen="CONFIRM_DEPASSEMENT",e.lotOpenIndice=n.indice;return}}}}function qr(e,r,l,n,o,s=!0){const _=l.VEN_UNIT_VE,E=n.ACH_PDS_NET&&n.ACH_COLIS?c.round(n.ACH_PDS_NET/n.ACH_COLIS,3):null,T=n.ACH_QUANTITE&&n.ACH_COLIS?c.round(n.ACH_QUANTITE/n.ACH_COLIS,0):null,I=n.Article;if(I&&(l.CODE_ART=I.ART_CODE,l.DESART=I.ART_LIB1,l.ART_STAT1=I.ART_STAT1,l.TRA_LOT=n.ACH_LOT,l.ACH_DLC=n.ACH_DLC,l.ACH_FOURNI_LIVR=n.ACH_FOURNI_LIVR,l.PDS_MOY_LOT=E,l.PIECE_MOY_LOT=T,l.CDT_MOYEN=l.TRA_LOT?le(_||"",l.PIECE_MOY_LOT,l.PDS_MOY_LOT):le(_||"",I.ART_PIECE_COL,I.ART_PDS_NET),s)){const N=Qr(r,n,o);l.NB_COLIS=W(e.formatColis,N.num_colis),l.NB_PIECES=W(e.formatPieces,N.num_pieces),l.PDS_NET=W(e.formatPoids,N.num_poids)}}function Kr(e){e.lotOpen=null,e.lotOpenIndice=null,e.lotPending=null,e.scanPending=null,c.each(e.Transactions,r=>{Ue(r)})}function Ye(e,r){const l=e.VEN_UNIT_VE;e.VEN_UNIT_CDE,e.CODE_ART=r.ART_CODE,e.DESART=r.ART_LIB1,e.ART_STAT1=r.ART_STAT1,e.TRA_LOT=null,e.ACH_DLC=null,e.ACH_FOURNI_LIVR=null,e.PIECE_MOY_LOT=(r==null?void 0:r.ART_PIECE_COL)??null,e.PDS_MOY_LOT=(r==null?void 0:r.ART_PDS_NET)??null,e.NB_COLIS=0,e.NB_PIECES=0,e.PDS_NET=0,e.CDT_MOYEN=le(l||"",e.PIECE_MOY_LOT,e.PDS_MOY_LOT),e.TYPE_SAISIE=oe(l||"",r)}function Ue(e){e.NB_COLIS=e.NB_COLIS_SAV,e.NB_PIECES=e.NB_PIECES_SAV,e.PDS_NET=e.PDS_NET_SAV}function rn(e){var r;e.Detail&&(e.Detail.VEN_QTE_LIV=Ce(((r=e.Detail)==null?void 0:r.VEN_UNIT_CDE)||"C",e.Transactions))}function jr(e){e.lotOpen=null,e.lotOpenIndice=null,e.lotPending=null,e.scanPending=null}function Wr(e,r){const l=e.Transactions.findIndex(n=>n.traSeq===r);l!==-1&&e.Transactions.splice(l,1),rn(e)}function Gr(e,r){e.Transactions.push(r),e.lotOpen=null,e.lotOpenIndice=null,e.lotPending=null,e.scanPending=null,rn(e)}function ln(e,r,l=null){function n(s){const _=[ee("ART_CODE",s.CODE_ART,"="),ee("STOCK_US",0,">")];s.CODE_DEPOT&&_.push(ee("ACH_DEPOT",s.CODE_DEPOT,"=")),l&&l.FournisseurEan&&_.push(ee("ACH_FOURNI_LIVR",l.FournisseurEan,"=")),l&&l.DlcEan&&_.push(ee("ACH_DLC",l.DlcEan,"=")),r.lotOpen="LIST_LOT",r.subTitle=l&&l.FournisseurEan?"fournisseur = "+l.FournisseurEan:"",r.lotOpenIndice=e,r.scanPending=l,r.rechercheLot=nr(_)}const o=r.Transactions.findIndex(s=>s.indice===e);n(o!==-1?r.Transactions[o]:r.newTransaction)}const ge=(e,r)=>y().PrepaFidegeMethods().RechercheInfoLotFidege({variables:{context:r,demande:{AchLot:e}}});async function on(e,r,l){var _,E;let n=null;if(!l)return{err:!1,res:null};if(l.Article){const T=Yr(e.Detail,l.Article);if(T)return{err:!0,res:null,message:T}}const s=(()=>{var T;if(((T=e.Detail.Article)==null?void 0:T.ART_STOCK)==="L"&&(l.NumeroLot==null||l.NumeroLotStock)){let I=e.newTransaction.TRA_LOT;if(I)return I}return l.NumeroLot})();if(s===null){if(l.NumeroLotStock===!1&&((_=e.Detail.Article)==null?void 0:_.ART_STOCK)==="L")return{err:!1,res:null,openModalLot:!0}}else s==l.NumeroLot&&l.InfoLot?n=l.InfoLot:n=((E=(await ge(s,r)).res)==null?void 0:E.result)||null;return n?{err:!1,res:n}:{err:!0,res:null,message:{key:"ERR_BATCH_NOTFOUND"}}}function zr(e,r,l){return{ART_STAT1:r.Article.ART_STAT1,CODE_ART:r.Article.ART_CODE,DESART:r.Article.ART_LIB1,ACH_LOT:r.ACH_LOT,scan:l}}function Te(e,r,l,n,o,s,_,E=!0,T=!0,I=!0){var g,O,a,A,p;const N=n===null?-1:l.Transactions.findIndex(Y=>Y.indice===n),S=N!==-1?l.Transactions[N]:l.newTransaction,P=((O=(g=l.Detail)==null?void 0:g.Article)==null?void 0:O.ART_DESTOCK_ART)||((a=l.Detail)==null?void 0:a.VEN_ART_CODE),M=(p=(A=l.Detail)==null?void 0:A.Article)==null?void 0:p.ART_STAT1;if(l.lotOpen="",l.lotOpenOrigine=null,l.autoCommit=null,E&&!o.ACH_VALORFAB){l.lotOpen="ERROR_LOT_NONVALOR",l.lotOpenOrigine=e,l.lotOpenIndice=n,l.lotPending=o;return}if(E&&o.ACH_DATE_SOLDE){l.lotOpen="CONFIRM_LOT_SOLDE",l.lotOpenOrigine=e,l.lotOpenIndice=n,l.lotPending=o,l.scanPending=s;return}if(P!==o.Article.ART_CODE){if(S.traSeq){l.lotOpen="ERROR_LOT_INVALID",l.lotOpenOrigine=e,l.lotOpenIndice=n,l.lotPending=o;return}if(M!==o.Article.ART_STAT1){l.lotOpen="ERROR_LOT_INVALID",l.lotOpenOrigine=e,l.lotOpenIndice=n,l.lotPending=o;return}else if(_){l.lotOpen="CONFIRM_REMPLACEMENT",l.lotOpenOrigine=e,l.lotOpenIndice=n,l.lotPending=o,l.scanPending=s,l.remplaceTransaction=zr(l.Detail,o,s);return}}qr(r,l.Detail,S,o,s,N===-1);const h=()=>N===-1&&T&&Hr(S,s&&e==="SCAN"&&s.TypeCodeBarre==="NOLOT"?"TRAITE_SCAN":"TRAITE_EAN")&&(I===!1||vr(l))?S.indice:null;l.autoCommit=N===-1?h()?S.indice:null:S.indice}function al(e,r){return!!(e&&e.USER_ZONE1==="O"&&(!e.USER_ZONE2||+e.USER_ZONE2&r))}const Zr=rr;function sn(e,r,l,n){var _,E,T,I;const o=(r.TRA_LOT?r.PIECEMOYLOT:null)??((_=e==null?void 0:e.Article)==null?void 0:_.ART_PIECE_COL)??null,s=(r.TRA_LOT?r.POIDSMOYLOT:null)??((E=e.Article)==null?void 0:E.ART_PDS_NET)??null;return{indice:r.TRA_SEQ,traSeq:r.TRA_SEQ,TRA_LOT:r.TRA_LOT,CODE_DEPOT:r.TRA_CODE_DEPOT,ACH_FOURNI_LIVR:r.ACH_FOURNI_LIVR,ACH_DLC:r.ACH_DLC,CODE_ART:(r.ArticleRemplacement||e.Article).ART_CODE,DESART:(r.ArticleRemplacement||e.Article).ART_LIB1,ART_STAT1:(r.ArticleRemplacement||e.Article).ART_STAT1,PICKING:(T=(r.ArticleRemplacement||e.Article).Picking)==null?void 0:T.PICK_CODE,ART_UNIT_VEN:(r.ArticleRemplacement||e.Article).ART_UNIT_VEN,NB_COLIS:r.TRA_COLIS_LIV,NB_PIECES:r.TRA_QUANTITE_LIV,PDS_NET:r.TRA_PDS_NET_LIV,NB_COLIS_SAV:r.TRA_COLIS_LIV,NB_PIECES_SAV:r.TRA_QUANTITE_LIV,PDS_NET_SAV:r.TRA_PDS_NET_LIV,CODE_EMB:"",VEN_UNIT_CDE:e.VEN_UNIT_CDE,VEN_UNIT_VE:e.VEN_UNIT_VE||"",NUM_DSD:null,preparateur:(l==null?void 0:l.PREP_CODE)||null,PIECE_MOY_LOT:o,PDS_MOY_LOT:s,TYPE_SAISIE:oe(e.VEN_UNIT_VE||"",r.ArticleRemplacement||e.Article),CDT_MOYEN:le(e.VEN_UNIT_VE||"",o,s),UVMODIFMODE:Me(e.VEN_UNIT_CDE,e.VEN_UNIT_VE,r.ArticleRemplacement||e.Article),UVMOD:e.VEN_UNIT_VE!=((I=e.Article)==null?void 0:I.ART_UNIT_VEN),NUM_SCAN:n?0:null}}function $r(e,r,l,n){var _,E,T,I,N;const o=((_=e==null?void 0:e.Article)==null?void 0:_.ART_PIECE_COL)??null,s=((E=e.Article)==null?void 0:E.ART_PDS_NET)??null;return{indice:-1,NB_COLIS:0,NB_PIECES:0,PDS_NET:0,traSeq:0,CODE_EMB:"",CODE_ART:e.Article.ART_CODE,DESART:e.VEN_LIB_ART,ART_STAT1:e.Article.ART_STAT1,ART_UNIT_VEN:e.Article.ART_UNIT_VEN,CODE_DEPOT:e.CODE_DEPOT,VEN_UNIT_CDE:e.VEN_UNIT_CDE,VEN_UNIT_VE:e.VEN_UNIT_VE||"",PICKING:(I=(T=e.Article)==null?void 0:T.Picking)==null?void 0:I.PICK_CODE,NUM_DSD:null,preparateur:(l==null?void 0:l.PREP_CODE)||null,TYPE_SAISIE:oe(e.VEN_UNIT_VE||"",e.Article),CDT_MOYEN:le(e.VEN_UNIT_VE||"",o,s),UVMODIFMODE:Me(e.VEN_UNIT_CDE,e.VEN_UNIT_VE,e.Article),UVMOD:e.VEN_UNIT_VE!=((N=e.Article)==null?void 0:N.ART_UNIT_VEN),TRA_LOT:null,ACH_DLC:null,ACH_FOURNI_LIVR:null,PIECE_MOY_LOT:o,PDS_MOY_LOT:s,NB_COLIS_SAV:null,NB_PIECES_SAV:null,PDS_NET_SAV:null,NUM_SCAN:n?0:null}}async function Xr(e,r,l,n,o,s,_,E,T,I){let N=Jr(r,l,n,I);(T||E)&&Le(l.Detail)&&(N.showCommentDetail=!!T,N.showComment=!!E);const{err:S,res:P,message:M,openModalLot:h}=await on(N,e,o);if(S)_(M);else if(h&&ln(null,N,o),P&&(Te("SCAN",s,N,null,P,o,!0),Ee(N))){const{errorValidation:g,preparationComplete:O}=re(N,!0);g&&me(N,g),N.autoCommitPreparationComplete=O}return N}function Jr(e,r,l,n){var _,E,T;const{Detail:o,Transactions:s}=r;return{openByScan:n,isScanning:!1,venNumSeq:e,venLotSeq:((_=r.Detail)==null?void 0:_.VEN_LOT_SEQ)??null,VEN_CDE:l.VEN_CDE,VEN_DATE_CDE:l.VEN_DATE_CDE,CLI_NOM:(E=l.Client)==null?void 0:E.CLI_NOM,CLI_CODE:(T=l.Client)==null?void 0:T.CLI_CODE,showComment:!1,showCommentDetail:!1,rechercheLot:null,lotOpen:null,subTitle:null,erreurCode:null,lotOpenIndice:null,lotOpenOrigine:null,lotPending:null,scanPending:null,autoCommit:null,autoCommitPreparationComplete:!1,mode:null,remplaceTransaction:null,Detail:o,Transactions:o?c.map(c.reject(s,I=>I.TRA_VALOR==="N"),I=>sn(o,I,l.Preparateur||null,n)):[],newTransaction:$r(o,null,l.Preparateur||null,n)}}const He=e=>({TRA_SEQ:e.traSeq,NB_COLIS:e.NB_COLIS,NB_PIECES:e.NB_PIECES,PDS_NET:e.PDS_NET,PDS_BRUT:e.PDS_NET,TRA_LOT:e.TRA_LOT,NUM_SCAN:e.NUM_SCAN,CODE_PREPARATEUR:e.preparateur||""}),Qe=(e,r)=>{var o,s,_,E,T,I;const l=c.isArray(r)?r[0]:r,n=l.UNIT_CDE==="P"?l.PDS_NET:l.UNIT_CDE==="C"?l.NB_COLIS:l.PDS_NET;return{CODE_ART:((s=(o=e.Detail)==null?void 0:o.Article)==null?void 0:s.ART_CODE)||"",LIBELLE_ART:((E=(_=e.Detail)==null?void 0:_.Article)==null?void 0:E.ART_LIB1)||"",UNIT_CDE:l.UNIT_CDE,QTE_ADD:n,LOT_ID:l.TRA_LOT,QTE_TOT:((T=e.Detail)==null?void 0:T.VEN_QTE_CDE)||0,QTE_PREP:((I=e.Detail)==null?void 0:I.VEN_QTE_LIV)||0}},el=e=>({CODE_DEPOT:e.CODE_DEPOT,NB_COLIS:e.NB_COLIS,NB_PIECES:e.NB_PIECES,PDS_NET:e.PDS_NET,PDS_BRUT:e.PDS_NET,TRA_LOT:e.TRA_LOT,CODE_EMB:e.CODE_EMB,CODE_ART:e.CODE_ART||"",UNIT_CDE:e.VEN_UNIT_CDE||"",DSD:e.NUM_DSD,SITE:null,PICKING:e.PICKING,RECALCUL:!1,NUM_SCAN:e.NUM_SCAN,CODE_PREPARATEUR:e.preparateur||""}),ne=(e,r,l=!1)=>({VEN_LOT_SEQ:e,Transactions:[el(r)],controleResteAPrearer:l});function nl(e,r,l){return{venNumSeq:e,venLotSeq:r,openByScan:l,isScanning:!0,VEN_CDE:0,VEN_DATE_CDE:null,CLI_NOM:"",CLI_CODE:"",showComment:!1,showCommentDetail:!1,rechercheLot:null,lotOpen:null,erreurCode:null,lotOpenIndice:null,lotOpenOrigine:null,lotPending:null,scanPending:null,autoCommit:null,autoCommitPreparationComplete:!1,mode:null,remplaceTransaction:null,Detail:null,Transactions:[],newTransaction:null}}const rl=e=>j({mutationFn:async r=>y().PrepaFidegeMethods().EnregistrePreparationDetailFidege({variables:{mutation:r,context:e.current}})}),qe=e=>((e==null?void 0:e.VEN_QTE_LIV)||0)<((e==null?void 0:e.VEN_QTE_CDE)||0),Dl=(e,r,l,n,o,s,_,E,T,I)=>{const N=Zr(),S=k.useRef(null),P=k.useRef(null),M=k.useRef(null),h=lr(e.current,l),g=Mr(e,r,l,{enabled:!!l&&!!r&&h.lockSuccess,cacheTime:n?1e3:0}),O=ir(()=>nl(r,l,!!n)),a=k.useSyncExternalStore(O.subscribe,()=>O.get()),A=(i,t)=>{O.set(typeof i=="function"?i(O.get()):i),t&&t(O.get())},[p]=or(e),[Y,w]=k.useState(null),F=Ve(),Ae=Ve(),d=We(),{queryClient:tn,clearCache:se,setStatus:un}=ze(),ae=(i=null)=>{const t=i||O.get(),u=qe(t.Detail);S.current!=u&&(S.current=u,un(r,S.current?1:-1))},b=async(i=!0,t=null,u=!1)=>{var m,R,D;try{const C=await(i?g.refetch().then(L=>L.data):g.data);if(g.error)return w(ur(g.error)),!1;if(!(C!=null&&C.detail)||!C.entete)return w("Détail non trouvé"),!1;let V=await Xr(e.current,r,C.detail,C.entete,t,N,Ae,u&&s,_,!!n);if(i||(S.current=qe(((m=C.detail)==null?void 0:m.Detail)||null)),V)if(t&&Ee(V)&&V.showComment===!1){const L=ne(l,V.newTransaction,!0),f=await cn.mutateAsyncLock(L);if(f!=null&&f.err||((R=f==null?void 0:f.res)==null?void 0:R.codeResult)!=="OK")F({key:((D=f==null?void 0:f.res)==null?void 0:D.codeResult)||"errorMessage"}),H();else if(V!=null&&V.autoCommitPreparationComplete)T(Qe(V,L.Transactions)),H();else return b();return!1}else return A(V),i&&ae(V),!0}catch(C){console.warn(C),w(C instanceof Error?C.message:typeof C=="string"?C:":(")}return null},he=j({mutationFn:async({mutation:i,closeOnComplete:t})=>(d.showModalWaitLock(),y().PrepaFidegeMethods().ModifieTransaction({variables:{mutation:i,context:e.current}})),async onSettled(i,t,u,m){var R,D;try{return i!=null&&i.err||((R=i==null?void 0:i.res)==null?void 0:R.codeResult)!=="OK"?(d.closeModalWaitLock(),F({key:((D=i==null?void 0:i.res)==null?void 0:D.codeResult)||"errorMessage"}),!0):(u.closeOnComplete?(d.closeModalWaitLock(),H()):(b(),d.closeModalWaitLock()),i.res.result)}catch{}}}),cn=rl(e),te=j({mutationFn:async({mutation:i,lock:t})=>(t&&d.showModalWaitLock(),y().PrepaFidegeMethods().EnregistrePreparationDetailFidege({variables:{mutation:i,context:e.current}})),async onSettled(i,t,u,m){var R,D,C,V;try{if(i!=null&&i.err||((R=i==null?void 0:i.res)==null?void 0:R.codeResult)!=="OK")return d.closeModalWaitLock(),F({key:((D=i==null?void 0:i.res)==null?void 0:D.codeResult)||"errorMessage"}),b(),!0;try{const L=await y().PrepaFidegeMethods().TransactionPreparationFidege({variables:{context:e.current,demande:i.res.result[0]}});if((C=L.res)!=null&&C.result){const f=sn(g.data.detail.Detail,L.res.result,((V=g.data.entete)==null?void 0:V.Preparateur)||null,u.mutation.Transactions[0].NUM_SCAN===0);A($=>B($,x=>{var Q;Gr(x,f),Ye(x.newTransaction,((Q=x.Detail)==null?void 0:Q.Article)||null)})),ae()}else b()}catch{b()}return d.closeModalWaitLock(),i.res.result}catch{}}}),de=sr({mutationFn:async i=>(i.TRA_SEQ||d.showModalWaitLock(),y().PrepaFidegeMethods().SupprimeTransactionFidege({variables:{mutation:i,context:e.current}})),onMutate:i=>{i.TRA_SEQ&&A(t=>B(t,u=>{Wr(u,i.TRA_SEQ)}))},async onSettled(i,t,u,m){var D,C;const R=()=>{S.current=null,se(["STATUT"]),b()};try{return i!=null&&i.err||((D=i==null?void 0:i.res)==null?void 0:D.codeResult)!=="OK"?(R(),F({key:((C=i==null?void 0:i.res)==null?void 0:C.codeResult)||"errorMessage"}),!0):(u.TRA_SEQ?ae():R(),i.res.result)}catch{R()}finally{u.TRA_SEQ||d.closeModalWaitLock()}}}),_n=j({mutationFn:async i=>(d.showModalWaitLock(),y().PrepaFidegeMethods().SubstitutionLigneFidege({variables:{mutation:i,context:e.current}})),async onSettled(i,t,u,m){var R,D,C,V,L;try{if(i!=null&&i.err||((R=i==null?void 0:i.res)==null?void 0:R.codeResult)!=="OK"||!i.res.result)return d.closeModalWaitLock(),F({key:((D=i==null?void 0:i.res)==null?void 0:D.codeResult)||"errorMessage"}),b(),!0;try{((C=i==null?void 0:i.res)==null?void 0:C.result)===l?b(!0,((V=a==null?void 0:a.remplaceTransaction)==null?void 0:V.scan)||null,!1).finally(()=>{d.closeModalWaitLock()}):(d.closeModalWaitLock(),i.res.result&&(P.current=null,E({VEN_LOT_SEQ:i.res.result,InfoCodeBarre:((L=a==null?void 0:a.remplaceTransaction)==null?void 0:L.scan)||null,disableCommentDetailModal:!0})))}catch{b(),d.closeModalWaitLock()}return i.res.result}catch{}}}),En=j({mutationFn:async i=>(d.showModalWaitLock(),y().PrepaFidegeMethods().DesoldeLotPreparation({variables:{mutation:i,context:e.current}})),async onSettled(i,t,u,m){var R,D;try{return i!=null&&i.err||((R=i==null?void 0:i.res)==null?void 0:R.codeResult)!=="OK"||!i.res.result?(d.closeModalWaitLock(),F({key:((D=i==null?void 0:i.res)==null?void 0:D.codeResult)||"errorMessage"}),!0):(d.closeModalWaitLock(),i.res.result)}catch{}}}),z=k.useMemo(()=>{let i=null,t=new tr,u=new fe(5);const m=()=>{(i==null||i.closed)&&(console.warn("subscribe"),i=(o?gr(o.pipe(cr(t)),u):u).pipe(_r(D=>{const C=async(L,f,$)=>{var x,Q;if(f){if(f.codeResult!=="OK"||!f.result.Article)return{err:!0,message:{options:{batchNumber:$},key:f.codeResult==="ERR_BATCH_INVALID"?"ERR_BATCH_INVALID":"ERR_SCAN_INVALID"},cancel:!0};if((x=f.result)!=null&&x.RemoteCommit)b();else{const{err:v,res:ce,message:Mn,openModalLot:Un}=await on(L,e.current,f.result);if(v)return{err:!0,message:Mn,cancel:!0};if(Un&&De(null,f.result),ce){const X=B(L,q=>{if(Te("SCAN",N,q,null,ce,f.result,!0,!0,!0,!1),!q.lotOpen){const{errorValidation:Re,preparationComplete:hn,restant:il}=re(q,!0);Re?me(q,Re):q.autoCommitPreparationComplete=hn}});if(Ee(X)){const q=ne(l,X.newTransaction);await te.mutateAsync({mutation:q,lock:!1}),X.autoCommitPreparationComplete&&(T(Qe(X,q.Transactions)),H());try{(Q=M.current)==null||Q.scrollIntoView({behavior:"instant"})}catch{}return{err:!1,message:null,cancel:!1}}else return A(X),{err:!1,message:null,cancel:!0}}}}return null},V=async(L,f)=>{const $={CodeBarre:D,VenNumSeq:L,VenLotSeq:f},x=await tn.fetchQuery({queryFn:({queryKey:ce})=>Ne(y().PrepaFidegeMethods().ScanEan128PreparationFidege({variables:{context:e.current,demande:$}})),queryKey:[Cr,e.getQueryKey(),D,L,f],cacheTime:1e4,staleTime:1e4}),Q=O.get();if(Q.lotOpen)throw new Error("UI LOCK");const v=await C(Q,x.res,D);if(v!=null&&v.err)return F(v.message).then(ce=>{throw new Error("UI LOCK")});if(v!=null&&v.cancel)throw new Error("UI LOCK");return x};return O.set({isScanning:!0}),V(r,l).finally(()=>{O.set({isScanning:!1})})})).subscribe({error(D){console.warn(D),t.next()}}))};return{subscribe:m,next:R=>{i&&i.closed&&(console.info("new ReplaySubject"),u=new fe,m()),u.next(R)},unsubscribe:()=>{i&&(console.info("unsubscribe"),u=new fe,i==null||i.unsubscribe())}}},[]);function Z(i){if(!i||!Ee(i))return;const t=c.find(i.Transactions,u=>u.indice===i.autoCommit);if(t)t.traSeq&&he.mutate({mutation:He(t),closeOnComplete:!1});else{const{errorValidation:u,preparationComplete:m}=re(i,!0);u===null&&te.mutate({mutation:ne(l,i.newTransaction),lock:!0},{onSettled:()=>{m&&H()}})}}function ue(i,t,u,m,R,D=!0){u&&u.Article&&A(C=>B(C,V=>{Te(i,N,V,t,u,m,R,D)}),Z)}function Tn(i,t,u,m){if(t==="TRA_LOT"){const R=u;if(R){const D=Ae;ge(R,e.current).then(C=>{var V,L,f;C.err||!((V=C.res)!=null&&V.result)?D({key:"ERR_BATCH_INVALID"}):(L=C==null?void 0:C.res)!=null&&L.result&&ue("SAISIE",i,(f=C==null?void 0:C.res)==null?void 0:f.result,null,!0)})}return}A(R=>B(R,D=>{ve(D,m?p:["C","P","N"],N,D.newTransaction,t,u),D.autoCommit=null}))}function ye(i,t,u,m){if(t==="TRA_LOT"){const R=u;if(R){const D=Ae;ge(R,e.current).then(C=>{var V,L,f;C.err||!((V=C.res)!=null&&V.result)?D({key:"ERR_BATCH_INVALID"}):(L=C==null?void 0:C.res)!=null&&L.result&&ue("SAISIE",i,(f=C==null?void 0:C.res)==null?void 0:f.result,null,!0)})}return}A(R=>B(R,D=>{const C=D.Transactions.findIndex(V=>V.indice===i);C!==-1&&(ve(D,m?p:["C","P","N"],N,D.Transactions[C],t,u),D.autoCommit=i)}),Z)}function Nn(){A(i=>B(i,t=>{var u;Ye(t.newTransaction,((u=t.Detail)==null?void 0:u.Article)||null)}))}function Cn(i){A(t=>B(t,u=>{u.lotOpen="CONFIRM_RAZ",u.erreurCode=null,u.lotOpenIndice=null}))}function In(i=!0){if(a){const{errorValidation:t,preparationComplete:u}=re(a,i);if(t){A(m=>B(m,R=>{me(R,t)}));return}return te.mutate({mutation:ne(l,a.newTransaction),lock:!0},{onSettled:()=>{u&&H()}})}}function On(i){i&&i.Article&&A(t=>B(t,u=>{Te("MODAL",N,u,u.lotOpenIndice,i,u.scanPending,!0,!0,!0)}),Z)}function H(){z.unsubscribe(),se(["DETAILS","COMMANDE","STATUT"]),I()}function An(){_n.mutate({ACH_LOT:a==null?void 0:a.remplaceTransaction.ACH_LOT,VEN_LOT_SEQ:l})}function an(){var i;(i=a==null?void 0:a.lotPending)!=null&&i.ACH_LOT&&(se(["SCAN"]),En.mutate({ACH_LOT:a.lotPending.ACH_LOT},{onSuccess:t=>{var u;(u=t.res)!=null&&u.result&&ue(a.lotOpenOrigine,a.lotOpenIndice,a.lotPending,a.scanPending,!0,!1)}}))}function Dn(){A(i=>B(i,t=>{t.mode=null,t.remplaceTransaction=null,t.lotOpen=null,t.lotOpenIndice=null}))}function De(i,t=null){se(["SCAN"]),A(u=>B(u,m=>{ln(i,m,t)}))}function Rn(){A(i=>B(i,t=>{if(t.showComment)t.showComment=!1;else{const u=t.Transactions.findIndex(m=>m.indice===t.lotOpenIndice);u!=-1&&Ue(t.Transactions[u]),t.lotOpen=null,t.lotOpenIndice=null,t.lotPending=null,t.scanPending=null}}),Z)}function Sn(){A(i=>B(i,t=>{t.showComment=!1}),Z)}function Pn(i){A(t=>B(t,u=>{jr(u)}),t=>{if(i===a.newTransaction.indice)return te.mutate({mutation:ne(l,a.newTransaction,!1),lock:!0},{onSettled:()=>{H()}});{const u=c.find(t.Transactions,m=>m.indice===i);if(u&&u.traSeq)return he.mutate({mutation:He(u),closeOnComplete:!1})}})}function fn(){A(i=>B(i,t=>{Kr(t)}))}function Vn(){A(i=>({...i,showCommentDetail:!1}))}async function mn(i){return z.next(i),Promise.resolve(i)}k.useEffect(()=>{const i=()=>{const u=P.current!=l;return P.current=l,b(!1,u?n:null,!0)};let t=!1;if(!g.isLoading)try{z.unsubscribe(),t=!0,i().then(u=>{u&&z.subscribe()})}catch{w("Crap")}return()=>{t&&z.unsubscribe()}},[g.isLoading]),k.useEffect(()=>{const i=h.lockSuccess;return()=>{i&&y().LockMethods().libereDetailCommande(e.current,l)}},[h.lockSuccess]);const gn=je(),pn=()=>de.mutate({LOT_SEQ:l,TRA_SEQ:null}),Ln=k.useMemo(()=>{const i=t=>de.mutate({LOT_SEQ:l,TRA_SEQ:t});return{format:N,onShowInputNumber:gn.showInputNumberSS,onDelete:i,onChangeForm:ye,onOpenLot:De}},[l]);return{lock:h,error:Y,actions:{onDeleteAllTransactions:pn,setForm:A,onChangeForm:ye,onHideComment:Vn,onChangeFormNew:Tn,onCloseModal:Rn,onConfirmDepassement:Pn,onCancelDepassement:fn,onConfirmLotSolde:an,onOpenModalLotSelection:De,onScanLecture:mn,onResetNewTransaction:Nn,onAskConfirmRaz:Cn,onManageSelectLot:ue,onManageSelectLotModal:On,onValidateNewTransaction:In,onConfirmRemplacement:An,onCloseRefresh:H,onCancelRemplacement:Dn,onCloseComment:Sn,refetch:()=>{w(null),b()}},detail:a,context:e,loading:g.isLoading,ListComponentsProps:Ln,infiniteRef:M}};export{Ur as D,Ol as I,Al as L,ge as R,ul as a,Dl as b,vr as c,Le as d,en as e,Vr as f,dr as g,El as h,al as i,Ve as j,cl as k,Mr as l,mr as m,Nl as n,Tl as o,Or as p,Cl as q,hr as r,Il as s,_l as t,Zr as u};
